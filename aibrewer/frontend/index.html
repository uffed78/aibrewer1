<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <title>Ölrecept App</title>
    <style>
        /* Grundläggande styling */
        body {
            margin: 0;
            display: flex;
            font-family: Arial, sans-serif;
            height: 100vh;
        }

        .sidebar {
            width: 220px;
            background-color: #f1f1f1;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar button:hover {
            background-color: #45a049;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none;
        }

        section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        h2 {
            margin-top: 0;
        }

        pre {
            background: #f8f8f8;
            padding: 10px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }

        #chatContainer {
            border-top: 2px solid #4CAF50;
            margin-top: 20px;
            padding-top: 10px;
        }

        #chatDisplay {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            margin-bottom: 10px;
        }
        
        #chatInputContainer {
            display: flex;
        }
        
        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
        }
        
        #sendChatBtn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        #sendChatBtn:hover {
            background-color: #45a049;
        }
        
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
        }
        
        .user-message {
            background-color: #e9f5f9;
            border-radius: 5px;
        }
        
        .assistant-message {
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <button id="getInventoryBtn">Hämta Inventory</button>
        <button id="suggestStylesBtn">Skicka Inventory till GPT</button>
        <button id="generateDraftBtn">Generera Draft</button>
        <button id="generateXmlBtn">Generera BeerXML</button>
    </div>

    <div class="main-content">
        <!-- Inventory Section -->
        <section id="inventorySection">
            <h2>Inventory</h2>
            <div id="inventoryDisplay">Klicka på "Hämta Inventory" för att ladda ingredienser.</div>
        </section>

        <!-- Stilförslag Section -->
        <section id="styleSuggestionsSection" class="hidden">
            <h2>Stilförslag</h2>
            <div id="styleSuggestions"></div>
            <div>
                <label for="customStyle">Eller ange eget förslag:</label>
                <input type="text" id="customStyle" placeholder="T.ex. Schwarzbier">
                <button id="customStyleBtn">Skicka eget förslag</button>
            </div>
        </section>

        <!-- Receptutkast Section -->
        <section id="draftSection" class="hidden">
            <h2>Receptutkast</h2>
            <div id="draftDisplay"></div>
        </section>

        <!-- Chat Section - Now always visible -->
        <section id="chatContainer">
            <h2>Diskutera med GPT</h2>
            <div id="chatDisplay"></div>
            <div id="chatInputContainer">
                <input type="text" id="chatInput" placeholder="Skriv en fråga om receptet...">
                <button id="sendChatBtn">Skicka</button>
            </div>
        </section>
    </div>

    <script>
        // Bas-URL för API-anrop, ändra vid behov
        const baseUrl = 'http://localhost:5001/function_a_v2';

        // Global variabel för att lagra inventory-data
        let inventoryData = null;
        
        // Global variabel för att lagra chatthistoriken
        let chatHistory = [];

        // Hämta inventory
        document.getElementById('getInventoryBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${baseUrl}/get-inventory`);
                const data = await response.json();
                inventoryData = data;
                displayInventory(data);
            } catch (error) {
                console.error('Fel vid hämtning av inventory:', error);
            }
        });

        // Visa inventory med grupperade kategorier och checkboxar
        function displayInventory(data) {
            console.log("Inventory Data:", data); // Logga API-svaret för felsökning
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            inventoryDisplay.innerHTML = '';

            ['fermentables', 'hops', 'yeasts'].forEach(category => {
                if (data[category] && data[category].length > 0) {
                    const section = document.createElement('div');
                    section.classList.add('inventory-category');

                    // Titel och "Markera/Avmarkera alla"-knapp
                    const header = document.createElement('h3');
                    header.textContent = category.charAt(0).toUpperCase() + category.slice(1);

                    const toggleAllBtn = document.createElement('button');
                    toggleAllBtn.textContent = 'Markera alla';
                    toggleAllBtn.style.marginLeft = '10px';
                    toggleAllBtn.style.fontSize = '12px';
                    toggleAllBtn.style.padding = '5px';
                    toggleAllBtn.dataset.category = category;
                    toggleAllBtn.onclick = () => toggleAllCheckboxes(category);

                    section.appendChild(header);
                    section.appendChild(toggleAllBtn);

                    data[category].forEach(item => {
                        const div = document.createElement('div');

                        // Hämta mängd från "inventory"-fältet
                        let amountText = 'okänd mängd';
                        if (item.inventory) {
                            if (category === 'fermentables') {
                                amountText = `${item.inventory.toFixed(2)} kg`;
                            } else if (category === 'hops') {
                                amountText = `${item.inventory.toFixed(2)} g`;
                            } else if (category === 'yeasts') {
                                amountText = `${item.inventory} paket`;
                            }
                        }

                        div.innerHTML = `
                    <input type="checkbox" class="ingredientCheckbox" data-category="${category}" data-name="${item.name}" checked>
                    ${item.name} - ${amountText}
                `;
                        section.appendChild(div);
                    });

                    inventoryDisplay.appendChild(section);
                }
            });
        }

        // Funktion för att markera/avmarkera alla ingredienser i en kategori
        function toggleAllCheckboxes(category) {
            const checkboxes = document.querySelectorAll(`.ingredientCheckbox[data-category="${category}"]`);
            let allChecked = Array.from(checkboxes).every(cb => cb.checked); // Kolla om alla redan är markerade

            checkboxes.forEach(cb => {
                cb.checked = !allChecked; // Växla status
            });

            // Uppdatera knappens text
            const button = document.querySelector(`button[data-category="${category}"]`);
            button.textContent = allChecked ? 'Markera alla' : 'Avmarkera alla';
        }

        // Hämta valda ingredienser
        function getSelectedIngredients() {
            const checkboxes = document.querySelectorAll('.ingredientCheckbox');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selected.push({
                        category: cb.getAttribute('data-category'),
                        name: cb.getAttribute('data-name')
                    });
                }
            });
            return selected;
        }

        // Skicka inventory till GPT för stilförslag
        document.getElementById('suggestStylesBtn').addEventListener('click', async () => {
            const ingredients = getSelectedIngredients();
            const profile = "Grainfather G30"; // Kan göras dynamiskt
            try {
                const response = await fetch(`${baseUrl}/suggest-styles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients, profile })
                });
                const data = await response.json();
                displayStyleSuggestions(data.styles);
            } catch (error) {
                console.error('Fel vid stilförslag:', error);
            }
        });

        // Visa stilförslag som knappar
        function displayStyleSuggestions(responseText) {
            console.log("Visar GPT:s stilförslag:", responseText);

            const styleSection = document.getElementById('styleSuggestionsSection');
            styleSection.classList.remove('hidden');
            const suggestionsDiv = document.getElementById('styleSuggestions');
            suggestionsDiv.innerHTML = '';

            // Visa hela GPT:s svar så att användaren kan läsa motiveringarna
            const explanation = document.createElement('p');
            explanation.innerHTML = `<strong>GPT:s förslag och resonemang:</strong><br>${responseText.replace(/\n/g, "<br>")}`;
            suggestionsDiv.appendChild(explanation);

            // Försök att extrahera stilnamnen genom att leta efter rader som börjar med en siffra (1. 2. 3.)
            const styleMatches = responseText.match(/\d+\.\s([^\n]+)/g);

            if (styleMatches) {
                styleMatches.forEach(match => {
                    const styleName = match.replace(/^\d+\.\s/, "").trim(); // Ta bort numreringen och behåll namnet
                    const btn = document.createElement('button');
                    btn.textContent = styleName;
                    btn.style.margin = "5px";
                    btn.addEventListener('click', () => {
                        generateDraft(styleName);
                    });
                    suggestionsDiv.appendChild(btn);
                });
            } else {
                console.warn("Kunde inte extrahera stilnamn automatiskt.");
            }
        }

        // Skicka eget stilförslag
        document.getElementById('customStyleBtn').addEventListener('click', () => {
            const customStyle = document.getElementById('customStyle').value.trim();
            if (customStyle) {
                generateDraft(customStyle);
            }
        });

        // Generera receptutkast (draft) baserat på valt stil och ingredienser
        async function generateDraft(style) {
            const ingredients = getSelectedIngredients();
            const profile = "Grainfather G30";
            try {
                const response = await fetch(`${baseUrl}/generate-draft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ style, ingredients, profile })
                });
                const data = await response.json();
                displayDraft(data.draft);
            } catch (error) {
                console.error('Fel vid generering av draft:', error);
            }
        }

        // Visa receptutkastet
        function displayDraft(draft) {
            console.log("Visar receptutkast:", draft);

            const draftSection = document.getElementById('draftSection');
            draftSection.classList.remove('hidden');

            const draftDisplay = document.getElementById('draftDisplay');

            // Spara den kompletta JSON-datan i en dold variabel
            draftDisplay.dataset.draft = JSON.stringify(draft);

            // Använd värden från backend direkt
            draftDisplay.innerHTML = `
        <h2>${draft.name || "Namnlöst recept"}</h2>
        <p><strong>OG:</strong> ${draft.target_og || "?"} | 
        <strong>IBU:</strong> ${draft.ibu || "?"} | 
        <strong>EBC:</strong> ${draft.ebc || "?"} | 
        <strong>ABV:</strong> ${draft.abv || "Beräknas senare"}</p>
        <h3>Maltsammansättning</h3>
        <ul>${Object.entries(draft.fermentables).map(([name, values]) => {
                const percent = values[0];
                const metadata = draft.fermentables_metadata[name] || {};
                return `<li><strong>${name}</strong> (${percent}%) - Färg: ${metadata.srm_color ? metadata.srm_color.toFixed(1) : "?"} SRM - Leverantör: ${metadata.supplier || "Okänd"}</li>`;
            }).join('')}</ul>
        <h3>Humle</h3>
        <ul>${(draft.hops || []).map(hop =>
                `<li><strong>${hop.name}</strong> - ${hop.alpha}% alpha - ${hop.ibu_contribution} IBU - ${hop.time} min koktid</li>`
            ).join('')}</ul>
        <h3>Jäst</h3>
        <p><strong>${draft.yeast?.type}</strong> - ${draft.yeast?.amount} paket</p>
        
        <!-- Lägg till uppdateringsknapp -->
        <div class="recipe-actions">
            <button id="updateRecipeBtn" class="action-button">Uppdatera recept baserat på chatt</button>
        </div>
    `;
            
            // Lägg till event listener för uppdateringsknappen
            setTimeout(() => {
                const updateBtn = document.getElementById('updateRecipeBtn');
                if (updateBtn) {
                    updateBtn.addEventListener('click', updateRecipeFromChat);
                }
            }, 100);
        }

        // Generera BeerXML
        document.getElementById('generateXmlBtn').addEventListener('click', async () => {
            console.log("⚡ Försöker generera BeerXML...");

            // ✅ Hämta den kompletta JSON-datan istället för bara det som syns
            const draftText = document.getElementById('draftDisplay').dataset.draft;

            if (!draftText) {
                alert("❌ Inget receptutkast att generera BeerXML från.");
                return;
            }

            let draft;
            try {
                draft = JSON.parse(draftText);
            } catch (error) {
                console.error("❌ Fel: Kunde inte tolka draft som JSON.", draftText);
                return;
            }

            const calculated = {};  // Placeholder, kan behöva uppdateras om vi lagrar beräkningar
            const profile = "Grainfather G30";

            // 🛠 Logga exakt vad som skickas till backend
            const payload = { draft, calculated, profile };
            console.log("📡 JSON som skickas till backend:", JSON.stringify(payload, null, 2));

            try {
                const response = await fetch(`${baseUrl}/generate-xml`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log("📡 API-svar från generate-xml:", response);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "recipe.xml";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    console.error('❌ Fel vid generering av BeerXML:', response.status, await response.text());
                }
            } catch (error) {
                console.error('❌ Fel vid generering av BeerXML:', error);
            }
        });

        // Uppdatera recept baserat på chathistorik
        async function updateRecipeFromChat() {
            console.log("⚡ Försöker uppdatera receptet baserat på chatthistorik...");
            
            // Hämta aktuellt recept
            const draftText = document.getElementById('draftDisplay').dataset.draft;
            if (!draftText) {
                alert("❌ Inget receptutkast att uppdatera.");
                return;
            }
            
            let draft;
            try {
                draft = JSON.parse(draftText);
            } catch (error) {
                console.error("❌ Fel: Kunde inte tolka draft som JSON.", draftText);
                return;
            }
            
            // Visa laddningsmeddelande
            addChatMessage("System", "Uppdaterar recept baserat på chatt...");
            
            try {
                // Skapa en ny endpoint på backend för receptuppdatering eller använd discuss-endpointen
                const response = await fetch(`${baseUrl}/discuss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            ...chatHistory,
                            { 
                                role: "user", 
                                content: "Baserat på vår diskussion ovan, uppdatera receptet och ge mig ett nytt komplett recept i JSON-format som följer exakt samma format som det nuvarande receptet. Ändra bara de delar vi diskuterat." 
                            }
                        ],
                        recipe: draft
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Försöka extrahera JSON från GPT:s svar
                    const jsonMatch = data.response.match(/```json\s*([\s\S]*?)\s*```/) || 
                                     data.response.match(/```\s*([\s\S]*?)\s*```/) ||
                                     data.response.match(/{[\s\S]*}/);
                    
                    if (jsonMatch) {
                        let newRecipeData;
                        
                        try {
                            // Försök parsa JSON-strängen
                            newRecipeData = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                            
                            // Uppdatera receptet i gränssnittet
                            displayDraft(newRecipeData);
                            
                            // Lägg till ett bekräftelsemeddelande
                            addChatMessage("System", "✅ Receptet har uppdaterats baserat på diskussionen.");
                            
                            // Uppdatera chatthistoriken
                            chatHistory.push({ role: "user", content: "Uppdatera receptet baserat på vår diskussion." });
                            chatHistory.push({ role: "assistant", content: data.response });
                            chatHistory.push({ role: "system", content: "Receptet har uppdaterats." });
                            
                        } catch (jsonError) {
                            console.error("❌ Kunde inte tolka GPT:s svar som JSON:", jsonError);
                            addChatMessage("System", "❌ Kunde inte uppdatera receptet automatiskt. GPT:s svar hade inte rätt format.");
                        }
                    } else {
                        addChatMessage("System", "❌ Kunde inte hitta JSON-data i GPT:s svar för att uppdatera receptet.");
                        console.error("Inget JSON-format hittades i GPT:s svar:", data.response);
                    }
                } else {
                    console.error('❌ Fel vid uppdatering av recept:', response.status);
                    addChatMessage("System", "❌ Ett fel uppstod vid kommunikation med servern.");
                }
            } catch (error) {
                console.error('❌ Fel vid uppdatering av recept:', error);
                addChatMessage("System", "❌ Ett fel uppstod: " + error.message);
            }
        }

        // Initiera chattfunktionalitet så fort sidan laddas
        document.addEventListener('DOMContentLoaded', function() {
            // Lägga till en startmeddelande i chatthistoriken
            addChatMessage("System", "Hej! Jag är din bryggassistent. Ställ frågor om receptet, ingredienser eller bryggning!");
            
            // Förbereda chatthistoriken med systeminformation
            chatHistory = [
                { role: "system", content: "Du är en AI-assistent som hjälper med ölbryggning. Använd svenska språket i dina svar." }
            ];
        });

        // Hantera att skicka chattmeddelanden
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value.trim();
            
            if (!userMessage) return;
            
            // Rensa input-fältet
            chatInput.value = '';
            
            // Visa användarens meddelande i chatten
            addChatMessage("Du", userMessage);
            
            // Hämta aktuellt recept om ett finns
            const draftText = document.getElementById('draftDisplay').dataset.draft || null;
            let draft = null;
            try {
                if (draftText) {
                    draft = JSON.parse(draftText);
                }
            } catch (error) {
                console.error("Kunde inte tolka draft som JSON:", draftText);
            }
            
            // Lägg till användarens meddelande i historiken
            chatHistory.push({ role: "user", content: userMessage });
            
            // Om ett nytt recept finns och det inte finns i historiken, lägg till det
            if (draft && !chatHistory.some(msg => msg.role === "system" && msg.content.includes("aktuella receptet"))) {
                chatHistory.push({ role: "system", content: `Det aktuella receptet: ${JSON.stringify(draft, null, 2)}` });
            }
            
            const payload = { messages: chatHistory, recipe: draft };
            
            try {
                // Visa en "loading" indikation
                const loadingId = addChatMessage("Assistent", "...");
                
                const response = await fetch(`${baseUrl}/discuss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Ta bort loading-meddelandet
                    document.getElementById(loadingId).remove();
                    
                    // Lägg till GPT:s svar i historiken och visa det
                    chatHistory.push({ role: "assistant", content: data.response });
                    addChatMessage("Assistent", data.response);
                } else {
                    console.error('Fel vid diskussion med GPT:', response.status);
                    document.getElementById(loadingId).textContent = "Det uppstod ett fel vid kommunikationen med GPT.";
                }
            } catch (error) {
                console.error('Fel vid diskussion med GPT:', error);
                addChatMessage("System", "Ett fel uppstod. Kunde inte ansluta till GPT.");
            }
        }

        // Lägg till ett meddelande i chatten och returnera elementets ID
        function addChatMessage(sender, text) {
            const chatDisplay = document.getElementById('chatDisplay');
            const messageDiv = document.createElement('div');
            const messageId = 'chat-msg-' + Date.now();
            
            messageDiv.id = messageId;
            messageDiv.className = 'chat-message ' + 
                (sender === 'Du' ? 'user-message' : 'assistant-message');
                
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            
            return messageId;
        }
    </script>
</body>

</html>