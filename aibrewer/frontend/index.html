<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <title>√ñlrecept App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Grundl√§ggande styling */
        body {
            margin: 0;
            display: flex;
            font-family: Arial, sans-serif;
            height: 100vh;
        }

        .sidebar {
            width: 220px;
            background-color: #f1f1f1;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar button:hover {
            background-color: #45a049;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none;
        }

        section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        h2 {
            margin-top: 0;
        }

        pre {
            background: #f8f8f8;
            padding: 10px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }

        #chatContainer {
            border-top: 2px solid #4CAF50;
            margin-top: 20px;
            padding-top: 10px;
        }

        #chatDisplay {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            margin-bottom: 10px;
        }
        
        #chatInputContainer {
            display: flex;
        }
        
        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
        }
        
        #sendChatBtn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        #sendChatBtn:hover {
            background-color: #45a049;
        }
        
        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
        }
        
        .user-message {
            background-color: #e9f5f9;
            border-radius: 5px;
        }
        
        .assistant-message {
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        /* Nya stilar f√∂r inst√§llningsdialog */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            background-color: #e9f5f9;
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .user-profile span {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .user-profile button {
            margin-left: auto;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        #settingsBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* L√§gg till stilar f√∂r personlighetsmodalerna */
        .personality-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .personality-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .personality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .personality-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .personality-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        .personality-card.selected {
            border-color: #4CAF50;
            background-color: #f0f7f0;
        }
        
        .personality-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .personality-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .personality-badge-icon {
            font-size: 24px;
            margin-right: 8px;
        }
        
        /* Mobilanpassning */
        @media screen and (max-width: 768px) {
            .personality-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .personality-modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>

<body>
    <!-- L√§gg till en inst√§llningsknapp i √∂vre h√∂gra h√∂rnet -->
    <button id="settingsBtn">‚öôÔ∏è Inst√§llningar</button>
    
    <!-- Inst√§llningsdialog -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Brewfather Inst√§llningar</h2>
            <div id="currentUserDisplay"></div>
            
            <form id="settingsForm">
                <div class="form-group">
                    <label for="username">Anv√§ndarnamn:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="apiId">Brewfather API ID:</label>
                    <input type="text" id="apiId" required>
                </div>
                <div class="form-group">
                    <label for="apiKey">Brewfather API Key:</label>
                    <input type="password" id="apiKey" required>
                </div>
                <button type="submit">Spara inst√§llningar</button>
            </form>
            
            <div id="savedProfiles">
                <h3>Sparade profiler</h3>
                <div id="userProfilesList">
                    <!-- Sparade profiler kommer att listas h√§r -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="sidebar">
        <button id="getInventoryBtn">H√§mta Inventory</button>
        <button id="suggestStylesBtn">Skicka Inventory till GPT</button>
        <!-- Removed unused button: generateDraftBtn -->
        <button id="generateXmlBtn">Generera BeerXML</button>
        <button id="brewerPersonalityBtn">
            <span id="currentBrewerIcon">üè∫</span> 
            <span id="currentBrewerName">Harald Traditionell</span>
        </button>
    </div>

    <!-- Personlighetsmodal -->
    <div id="personalityModal" class="personality-modal">
        <div class="personality-modal-content">
            <span class="close">&times;</span>
            <h2>V√§lj din bryggarm√§stare</h2>
            <p>Vem vill du ska hj√§lpa dig med dina √∂lrecept?</p>
            
            <div id="personalityGrid" class="personality-grid">
                <!-- Personlighetskort genereras dynamiskt via JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Fast personlighetsbadge i nedre h√∂gra h√∂rnet -->
    <div class="personality-badge" id="personalityBadge">
        <span class="personality-badge-icon" id="badgeIcon">üè∫</span>
        <span id="badgeName">Harald Traditionell</span>
    </div>

    <div class="main-content">
        <!-- Inventory Section -->
        <section id="inventorySection">
            <h2>Inventory</h2>
            <div id="inventoryDisplay">Klicka p√• "H√§mta Inventory" f√∂r att ladda ingredienser.</div>
        </section>

        <!-- Stilf√∂rslag Section -->
        <section id="styleSuggestionsSection" class="hidden">
            <h2>Stilf√∂rslag</h2>
            <div id="styleSuggestions"></div>
            <div>
                <label for="customStyle">Eller ange eget f√∂rslag:</label>
                <input type="text" id="customStyle" placeholder="T.ex. Schwarzbier">
                <button id="customStyleBtn">Skicka eget f√∂rslag</button>
            </div>
        </section>

        <!-- Receptutkast Section -->
        <section id="draftSection" class="hidden">
            <h2>Receptutkast</h2>
            <div id="draftDisplay"></div>
        </section>

        <!-- Chat Section - Now always visible -->
        <section id="chatContainer">
            <h2>Diskutera med GPT</h2>
            <div id="chatDisplay"></div>
            <div id="chatInputContainer">
                <input type="text" id="chatInput" placeholder="Skriv en fr√•ga om receptet...">
                <button id="sendChatBtn">Skicka</button>
            </div>
        </section>
    </div>

    <script>
        // Bas-URL f√∂r API-anrop, √§ndra vid behov
        const baseUrl = 'http://localhost:5001/function_a_v2';

        // Global variabel f√∂r att lagra inventory-data
        let inventoryData = null;
        
        // Global variabel f√∂r att lagra chatthistoriken
        let chatHistory = [];
        
        // Global variabel f√∂r anv√§ndarinst√§llningar
        let currentUser = null;

        // Globala variabler
        let currentPersonality = 'traditionalist';
        let allPersonalities = {};
        
        // Initiera anv√§ndarhantering och inst√§llningsdialog
        document.addEventListener('DOMContentLoaded', function() {
            initUserSettings();
            
            // F√∂rbereda chatthistoriken med systeminformation
            chatHistory = [
                { role: "system", content: "Du √§r en AI-assistent som hj√§lper med √∂lbryggning. Anv√§nd svenska spr√•ket i dina svar." }
            ];
            
            // Initialisera chattfunktionalitet - bara ett v√§lkomstmeddelande
            addChatMessage("System", "Hej! Jag √§r din bryggassistent. St√§ll fr√•gor om receptet, ingredienser eller bryggning!");

            // F√∂rs√∂k l√§sa sparad personlighet fr√•n local storage
            const savedPersonality = localStorage.getItem('aibrewerPersonality');
            if (savedPersonality) {
                currentPersonality = savedPersonality;
            }
            
            // Ladda personligheter fr√•n API
            loadPersonalities();
        });
        
        // Inst√§llningshantering
        function initUserSettings() {
            // H√§mta sparade anv√§ndarprofiler
            let savedProfiles = JSON.parse(localStorage.getItem('brewfatherProfiles')) || [];
            
            // H√§mta senast anv√§nda profil
            let lastUsedProfile = localStorage.getItem('lastUsedProfile');
            
            if (lastUsedProfile) {
                currentUser = savedProfiles.find(p => p.username === lastUsedProfile);
            }
            
            // Om det finns en profil, visa den
            if (currentUser) {
                document.getElementById('username').value = currentUser.username;
                document.getElementById('apiId').value = currentUser.apiId;
                document.getElementById('apiKey').value = currentUser.apiKey;
                updateCurrentUserDisplay();
            }
            
            // Visa alla sparade profiler
            updateUserProfilesList(savedProfiles);
            
            // Hantera inst√§llningsformul√§r
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const apiId = document.getElementById('apiId').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                // Uppdatera savedProfiles
                let profiles = JSON.parse(localStorage.getItem('brewfatherProfiles')) || [];
                
                // Kolla om anv√§ndaren redan finns
                const existingIndex = profiles.findIndex(p => p.username === username);
                
                if (existingIndex >= 0) {
                    profiles[existingIndex] = { username, apiId, apiKey };
                } else {
                    profiles.push({ username, apiId, apiKey });
                }
                
                // Spara till localStorage
                localStorage.setItem('brewfatherProfiles', JSON.stringify(profiles));
                localStorage.setItem('lastUsedProfile', username);
                
                // Uppdatera currentUser
                currentUser = { username, apiId, apiKey };
                
                // Uppdatera UI
                updateUserProfilesList(profiles);
                updateCurrentUserDisplay();
                
                // St√§ng modal
                document.getElementById('settingsModal').style.display = 'none';
                
                alert(`Inst√§llningar sparade f√∂r ${username}`);
            });
            
            // √ñppna inst√§llningsdialogen
            document.getElementById('settingsBtn').addEventListener('click', function() {
                document.getElementById('settingsModal').style.display = 'block';
            });
            
            // St√§ng inst√§llningsdialogen
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('settingsModal').style.display = 'none';
            });
            
            // St√§ng dialogen om anv√§ndaren klickar utanf√∂r
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('settingsModal')) {
                    document.getElementById('settingsModal').style.display = 'none';
                }
            });
        }
        
        // Uppdatera listan √∂ver anv√§ndarprofiler
        function updateUserProfilesList(profiles) {
            const listElement = document.getElementById('userProfilesList');
            listElement.innerHTML = '';
            
            if (profiles.length === 0) {
                listElement.innerHTML = '<p>Inga profiler sparade √§nnu.</p>';
                return;
            }
            
            profiles.forEach(profile => {
                const profileDiv = document.createElement('div');
                profileDiv.className = 'user-profile';
                
                profileDiv.innerHTML = `
                    <span>${profile.username}</span>
                    <button class="use-profile" data-username="${profile.username}">Anv√§nd</button>
                    <button class="delete-profile" data-username="${profile.username}">Ta bort</button>
                `;
                
                listElement.appendChild(profileDiv);
            });
            
            // L√§gg till h√§ndelsehanterare f√∂r knapparna
            document.querySelectorAll('.use-profile').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const profile = profiles.find(p => p.username === username);
                    
                    if (profile) {
                        document.getElementById('username').value = profile.username;
                        document.getElementById('apiId').value = profile.apiId;
                        document.getElementById('apiKey').value = profile.apiKey;
                        
                        // Uppdatera currentUser och spara till localStorage
                        currentUser = profile;
                        localStorage.setItem('lastUsedProfile', username);
                        updateCurrentUserDisplay();
                    }
                });
            });
            
            document.querySelectorAll('.delete-profile').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    if (confirm(`√Ñr du s√§ker p√• att du vill ta bort profilen f√∂r ${username}?`)) {
                        const updatedProfiles = profiles.filter(p => p.username !== username);
                        localStorage.setItem('brewfatherProfiles', JSON.stringify(updatedProfiles));
                        
                        // Om den borttagna profilen var den aktiva, nollst√§ll currentUser
                        if (currentUser && currentUser.username === username) {
                            currentUser = null;
                            localStorage.removeItem('lastUsedProfile');
                            document.getElementById('username').value = '';
                            document.getElementById('apiId').value = '';
                            document.getElementById('apiKey').value = '';
                            updateCurrentUserDisplay();
                        }
                        
                        updateUserProfilesList(updatedProfiles);
                    }
                });
            });
        }
        
        // Uppdatera visningen av nuvarande anv√§ndare
        function updateCurrentUserDisplay() {
            const displayElement = document.getElementById('currentUserDisplay');
            
            if (currentUser) {
                displayElement.innerHTML = `<div class="current-user">Inloggad som: <strong>${currentUser.username}</strong></div>`;
            } else {
                displayElement.innerHTML = '<div class="current-user">Ingen anv√§ndare vald</div>';
            }
        }
        
        // H√§mta inventory - uppdaterad f√∂r att skicka med anv√§ndaruppgifter
        document.getElementById('getInventoryBtn').addEventListener('click', async () => {
            if (!currentUser) {
                alert("Du m√•ste konfigurera en Brewfather-profil f√∂rst. Klicka p√• 'Inst√§llningar'.");
                document.getElementById('settingsModal').style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${baseUrl}/get-inventory`, {
                    method: 'POST',  // √Ñndrad till POST f√∂r att kunna skicka anv√§ndaruppgifter
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiId: currentUser.apiId,
                        apiKey: currentUser.apiKey
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(`Fel: ${data.error}`);
                    return;
                }
                
                inventoryData = data;
                displayInventory(data);
            } catch (error) {
                console.error('Fel vid h√§mtning av inventory:', error);
                alert(`Ett fel intr√§ffade: ${error.message}`);
            }
        });

        // Visa inventory med grupperade kategorier och checkboxar
        function displayInventory(data) {
            console.log("Inventory Data:", data); // Logga API-svaret f√∂r fels√∂kning
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            inventoryDisplay.innerHTML = '';

            ['fermentables', 'hops', 'yeasts'].forEach(category => {
                if (data[category] && data[category].length > 0) {
                    const section = document.createElement('div');
                    section.classList.add('inventory-category');

                    // Titel och "Markera/Avmarkera alla"-knapp
                    const header = document.createElement('h3');
                    header.textContent = category.charAt(0).toUpperCase() + category.slice(1);

                    const toggleAllBtn = document.createElement('button');
                    toggleAllBtn.textContent = 'Markera alla';
                    toggleAllBtn.style.marginLeft = '10px';
                    toggleAllBtn.style.fontSize = '12px';
                    toggleAllBtn.style.padding = '5px';
                    toggleAllBtn.dataset.category = category;
                    toggleAllBtn.onclick = () => toggleAllCheckboxes(category);

                    section.appendChild(header);
                    section.appendChild(toggleAllBtn);

                    data[category].forEach(item => {
                        const div = document.createElement('div');

                        // H√§mta m√§ngd fr√•n "inventory"-f√§ltet
                        let amountText = 'ok√§nd m√§ngd';
                        if (item.inventory) {
                            if (category === 'fermentables') {
                                amountText = `${item.inventory.toFixed(2)} kg`;
                            } else if (category === 'hops') {
                                amountText = `${item.inventory.toFixed(2)} g`;
                            } else if (category === 'yeasts') {
                                amountText = `${item.inventory} paket`;
                            }
                        }

                        div.innerHTML = `
                    <input type="checkbox" class="ingredientCheckbox" data-category="${category}" data-name="${item.name}" checked>
                    ${item.name} - ${amountText}
                `;
                        section.appendChild(div);
                    });

                    inventoryDisplay.appendChild(section);
                }
            });
        }

        // Funktion f√∂r att markera/avmarkera alla ingredienser i en kategori
        function toggleAllCheckboxes(category) {
            const checkboxes = document.querySelectorAll(`.ingredientCheckbox[data-category="${category}"]`);
            let allChecked = Array.from(checkboxes).every(cb => cb.checked); // Kolla om alla redan √§r markerade

            checkboxes.forEach(cb => {
                cb.checked = !allChecked; // V√§xla status
            });

            // Uppdatera knappens text
            const button = document.querySelector(`button[data-category="${category}"]`);
            button.textContent = allChecked ? 'Markera alla' : 'Avmarkera alla';
        }

        // H√§mta valda ingredienser
        function getSelectedIngredients() {
            const checkboxes = document.querySelectorAll('.ingredientCheckbox');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selected.push({
                        category: cb.getAttribute('data-category'),
                        name: cb.getAttribute('data-name')
                    });
                }
            });
            return selected;
        }

        // Skicka inventory till GPT f√∂r stilf√∂rslag
        document.getElementById('suggestStylesBtn').addEventListener('click', async () => {
            const ingredients = getSelectedIngredients();
            const profile = "Grainfather G30"; // Kan g√∂ras dynamiskt
            
            console.log("Using personality for API call:", currentPersonality);
            
            try {
                const response = await fetch(`${baseUrl}/suggest-styles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: ingredients,
                        profile: profile,
                        personality: currentPersonality  // updated to use currentPersonality
                    })
                });
                const data = await response.json();
                displayStyleSuggestions(data.styles);
            } catch (error) {
                console.error('Fel vid stilf√∂rslag:', error);
            }
        });

        // Visa stilf√∂rslag som knappar
        function displayStyleSuggestions(responseText) {
            console.log("Visar GPT:s stilf√∂rslag:", responseText);

            const styleSection = document.getElementById('styleSuggestionsSection');
            styleSection.classList.remove('hidden');
            const suggestionsDiv = document.getElementById('styleSuggestions');
            suggestionsDiv.innerHTML = '';

            // Visa hela GPT:s svar s√• att anv√§ndaren kan l√§sa motiveringarna
            const explanation = document.createElement('p');
            explanation.innerHTML = `<strong>GPT:s f√∂rslag och resonemang:</strong><br>${responseText.replace(/\n/g, "<br>")}`;
            suggestionsDiv.appendChild(explanation);

            // F√∂rs√∂k att extrahera stilnamnen genom att leta efter rader som b√∂rjar med en siffra (1. 2. 3.)
            const styleMatches = responseText.match(/\d+\.\s([^\n]+)/g);

            if (styleMatches) {
                styleMatches.forEach(match => {
                    const styleName = match.replace(/^\d+\.\s/, "").trim(); // Ta bort numreringen och beh√•ll namnet
                    const btn = document.createElement('button');
                    btn.textContent = styleName;
                    btn.style.margin = "5px";
                    btn.addEventListener('click', () => {
                        generateDraft(styleName);
                    });
                    suggestionsDiv.appendChild(btn);
                });
            } else {
                console.warn("Kunde inte extrahera stilnamn automatiskt.");
            }
        }

        // Skicka eget stilf√∂rslag
        document.getElementById('customStyleBtn').addEventListener('click', () => {
            const customStyle = document.getElementById('customStyle').value.trim();
            if (customStyle) {
                generateDraft(customStyle);
            }
        });

        // Generera receptutkast (draft) baserat p√• valt stil och ingredienser
        async function generateDraft(style) {
            const ingredients = getSelectedIngredients();
            const profile = "Grainfather G30";
            
            if (ingredients.length === 0) {
                alert("Du m√•ste v√§lja minst en ingrediens f√∂r att generera ett recept.");
                return;
            }
            
            // Check if user credentials exist
            if (!currentUser) {
                alert("Du m√•ste konfigurera en Brewfather-profil f√∂rst. Klicka p√• 'Inst√§llningar'.");
                document.getElementById('settingsModal').style.display = 'block';
                return;
            }
            
            // Show loading state
            const draftSection = document.getElementById('draftSection');
            draftSection.classList.remove('hidden');
            const draftDisplay = document.getElementById('draftDisplay');
            draftDisplay.innerHTML = '<div style="text-align: center; padding: 20px;"><b>Genererar receptutkast...</b><br>Detta kan ta upp till 30 sekunder.</div>';
            
            try {
                console.log(`Genererar recept f√∂r stil: "${style}" med ingredienser:`, ingredients);
                
                const response = await fetch(`${baseUrl}/generate-draft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        style, 
                        ingredients, 
                        profile,
                        apiId: currentUser.apiId,
                        apiKey: currentUser.apiKey,
                        inventory_data: inventoryData // Send cached inventory data if available
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    const errorMessage = data.error || "Det uppstod ett fel vid generering av receptutkast";
                    console.error('API error:', errorMessage, data);
                    throw new Error(errorMessage);
                }
                
                displayDraft(data.draft);
            } catch (error) {
                console.error('Fel vid generering av draft:', error);
                draftDisplay.innerHTML = `<div style="color: red; padding: 10px; border: 1px solid red; margin: 10px 0;">
                    <b>Fel vid generering av recept:</b><br>${error.message}<br><br>
                    <button id="retryDraftBtn">F√∂rs√∂k igen</button>
                </div>`;
                
                // Add retry button functionality
                setTimeout(() => {
                    const retryBtn = document.getElementById('retryDraftBtn');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => generateDraft(style));
                    }
                }, 100);
            }
        }

        // Visa receptutkastet
        function displayDraft(draft) {
            console.log("Visar receptutkast:", draft);

            const draftSection = document.getElementById('draftSection');
            draftSection.classList.remove('hidden');

            const draftDisplay = document.getElementById('draftDisplay');

            // Spara den kompletta JSON-datan i en dold variabel
            draftDisplay.dataset.draft = JSON.stringify(draft);

            // Anv√§nd v√§rden fr√•n backend direkt
            draftDisplay.innerHTML = `
        <h2>${draft.name || "Namnl√∂st recept"}</h2>
        <p><strong>OG:</strong> ${draft.target_og || "?"} | 
        <strong>IBU:</strong> ${draft.ibu || "?"} | 
        <strong>EBC:</strong> ${draft.ebc || "?"} | 
        <strong>ABV:</strong> ${draft.abv || "Ber√§knas senare"}</p>
        <h3>Maltsammans√§ttning</h3>
        <ul>${Object.entries(draft.fermentables).map(([name, values]) => {
                const percent = values[0];
                const metadata = draft.fermentables_metadata[name] || {};
                return `<li><strong>${name}</strong> (${percent}%) - F√§rg: ${metadata.srm_color ? metadata.srm_color.toFixed(1) : "?"} SRM - Leverant√∂r: ${metadata.supplier || "Ok√§nd"}</li>`;
            }).join('')}</ul>
        <h3>Humle</h3>
        <ul>${(draft.hops || []).map(hop =>
                `<li><strong>${hop.name}</strong> - ${hop.alpha}% alpha - ${hop.ibu_contribution} IBU - ${hop.time} min koktid</li>`
            ).join('')}</ul>
        <h3>J√§st</h3>
        <p><strong>${draft.yeast?.type}</strong> - ${draft.yeast?.amount} paket</p>
        
        <!-- L√§gg till uppdateringsknapp -->
        <div class="recipe-actions">
            <button id="updateRecipeBtn" class="action-button">Uppdatera recept baserat p√• chatt</button>
        </div>
    `;
            // L√§gg till event listener f√∂r uppdateringsknappen
            setTimeout(() => {
                const updateBtn = document.getElementById('updateRecipeBtn');
                if (updateBtn) {
                    updateBtn.addEventListener('click', updateRecipeFromChat);
                }
            }, 100);
        }

        // Generera BeerXML
        document.getElementById('generateXmlBtn').addEventListener('click', async () => {
            console.log("‚ö° F√∂rs√∂ker generera BeerXML...");

            // Check if user credentials exist
            if (!currentUser) {
                alert("Du m√•ste konfigurera en Brewfather-profil f√∂rst. Klicka p√• 'Inst√§llningar'.");
                document.getElementById('settingsModal').style.display = 'block';
                return;
            }

            // ‚úÖ H√§mta den kompletta JSON-datan ist√§llet f√∂r bara det som syns
            const draftText = document.getElementById('draftDisplay').dataset.draft;

            if (!draftText) {
                alert("‚ùå Inget receptutkast att generera BeerXML fr√•n.");
                return;
            }

            let draft;
            try {
                draft = JSON.parse(draftText);
            } catch (error) {
                console.error("‚ùå Fel: Kunde inte tolka draft som JSON.", draftText);
                return;
            }

            const calculated = {};  // Placeholder, kan beh√∂va uppdateras om vi lagrar ber√§kningar
            const profile = "Grainfather G30";

            // Show loading indicator
            const btnOrigText = document.getElementById('generateXmlBtn').textContent;
            document.getElementById('generateXmlBtn').textContent = "Genererar...";
            document.getElementById('generateXmlBtn').disabled = true;

            // üõ† Logga exakt vad som skickas till backend
            const payload = { 
                draft, 
                calculated, 
                profile,
                apiId: currentUser.apiId,
                apiKey: currentUser.apiKey
            };
            console.log("üì° JSON som skickas till backend:", JSON.stringify(payload, null, 2));

            try {
                const response = await fetch(`${baseUrl}/generate-xml`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log("üì° API-svar fr√•n generate-xml:", response);

                // Reset button
                document.getElementById('generateXmlBtn').textContent = btnOrigText;
                document.getElementById('generateXmlBtn').disabled = false;

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "recipe.xml";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    // Parse and show the error message
                    const errorData = await response.json();
                    console.error('‚ùå Fel vid generering av BeerXML:', errorData);
                    alert(`Fel vid generering av BeerXML: ${errorData.error || response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Fel vid generering av BeerXML:', error);
                alert(`Ett fel uppstod: ${error.message}`);
                
                // Reset button on error too
                document.getElementById('generateXmlBtn').textContent = btnOrigText;
                document.getElementById('generateXmlBtn').disabled = false;
            }
        });

        // Uppdatera recept baserat p√• chathistorik
        async function updateRecipeFromChat() {
            console.log("‚ö° F√∂rs√∂ker uppdatera receptet baserat p√• chatthistorik...");
            
            // H√§mta aktuellt recept
            const draftText = document.getElementById('draftDisplay').dataset.draft;
            if (!draftText) {
                alert("‚ùå Inget receptutkast att uppdatera.");
                return;
            }
            
            let draft;
            try {
                draft = JSON.parse(draftText);
            } catch (error) {
                console.error("‚ùå Fel: Kunde inte tolka draft som JSON.", draftText);
                return;
            }
            
            // Visa laddningsmeddelande
            addChatMessage("System", "Uppdaterar recept baserat p√• chatt...");
            
            try {
                // Skapa en ny endpoint p√• backend f√∂r receptuppdatering eller anv√§nd discuss-endpointen
                const response = await fetch(`${baseUrl}/discuss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            ...chatHistory,
                            { 
                                role: "user", 
                                content: "Baserat p√• v√•r diskussion ovan, uppdatera receptet och ge mig ett nytt komplett recept i JSON-format som f√∂ljer exakt samma format som det nuvarande receptet. √Ñndra bara de delar vi diskuterat." 
                            }
                        ],
                        recipe: draft
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // F√∂rs√∂ka extrahera JSON fr√•n GPT:s svar
                    const jsonMatch = data.response.match(/```json\s*([\s\S]*?)\s*```/) || 
                                     data.response.match(/```\s*([\s\S]*?)\s*```/) ||
                                     data.response.match(/{[\s\S]*}/);
                    
                    if (jsonMatch) {
                        let newRecipeData;
                        
                        try {
                            // F√∂rs√∂k parsa JSON-str√§ngen
                            newRecipeData = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                            
                            // Uppdatera receptet i gr√§nssnittet
                            displayDraft(newRecipeData);
                            
                            // L√§gg till ett bekr√§ftelsemeddelande
                            addChatMessage("System", "‚úÖ Receptet har uppdaterats baserat p√• diskussionen.");
                            
                            // Uppdatera chatthistoriken
                            chatHistory.push({ role: "user", content: "Uppdatera receptet baserat p√• v√•r diskussion." });
                            chatHistory.push({ role: "assistant", content: data.response });
                            chatHistory.push({ role: "system", content: "Receptet har uppdaterats." });
                            
                        } catch (jsonError) {
                            console.error("‚ùå Kunde inte tolka GPT:s svar som JSON:", jsonError);
                            addChatMessage("System", "‚ùå Kunde inte uppdatera receptet automatiskt. GPT:s svar hade inte r√§tt format.");
                        }
                    } else {
                        addChatMessage("System", "‚ùå Kunde inte hitta JSON-data i GPT:s svar f√∂r att uppdatera receptet.");
                        console.error("Inget JSON-format hittades i GPT:s svar:", data.response);
                    }
                } else {
                    console.error('‚ùå Fel vid uppdatering av recept:', response.status);
                    addChatMessage("System", "‚ùå Ett fel uppstod vid kommunikation med servern.");
                }
            } catch (error) {
                console.error('‚ùå Fel vid uppdatering av recept:', error);
                addChatMessage("System", "‚ùå Ett fel uppstod: " + error.message);
            }
        }

        // Hantera att skicka chattmeddelanden
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            
            console.log("Sending chat message with personality:", currentPersonality);
            
            chatInput.value = '';
            addChatMessage("Du", userMessage);
            
            const draftText = document.getElementById('draftDisplay').dataset.draft || null;
            let draft = null;
            try {
                if (draftText) {
                    draft = JSON.parse(draftText);
                }
            } catch (error) {
                console.error("Kunde inte tolka draft som JSON:", draftText);
            }
            
            chatHistory.push({ role: "user", content: userMessage });
            if (draft && !chatHistory.some(msg => msg.role === "system" && msg.content.includes("aktuella receptet"))) {
                chatHistory.push({ role: "system", content: `Det aktuella receptet: ${JSON.stringify(draft, null, 2)}` });
            }
            
            // NYTT: L√§gg till information om tillg√§ngliga ingredienser om vi har inventory-data
            if (inventoryData && !chatHistory.some(msg => msg.role === "system" && msg.content.includes("tillg√§ngliga ingredienser"))) {
                // Skapa en sammanfattning av tillg√§ngliga ingredienser
                const inventorySummary = {
                    fermentables: inventoryData.fermentables.map(item => ({
                        name: item.name,
                        amount: `${item.inventory} kg`,
                        color: item.color || "N/A"
                    })),
                    hops: inventoryData.hops.map(item => ({
                        name: item.name,
                        amount: `${item.inventory} g`, 
                        alpha: item.alpha || "N/A"
                    })),
                    yeasts: inventoryData.yeasts.map(item => ({
                        name: item.name,
                        amount: `${item.inventory} pkg`
                    }))
                };
                
                chatHistory.push({ 
                    role: "system", 
                    content: `Tillg√§ngliga ingredienser i anv√§ndarens inventory: ${JSON.stringify(inventorySummary, null, 2)}`
                });
            }
            
            const payload = { 
                messages: chatHistory, 
                recipe: draft,
                inventory: inventoryData,
                personality: currentPersonality  // updated personality parameter
            };
            
            try {
                const loadingId = addChatMessage("Assistent", "...");
                const response = await fetch(`${baseUrl}/discuss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(loadingId).remove();
                    chatHistory.push({ role: "assistant", content: data.response });
                    addChatMessage("Assistent", data.response);
                } else {
                    console.error('Fel vid diskussion med GPT:', response.status);
                    document.getElementById(loadingId).textContent = "Det uppstod ett fel vid kommunikationen med GPT.";
                }
            } catch (error) {
                console.error('Fel vid diskussion med GPT:', error);
                addChatMessage("System", "Ett fel uppstod. Kunde inte ansluta till GPT.");
            }
        }
        
        // L√§gg till ett meddelande i chatten och returnera elementets ID
        function addChatMessage(sender, text) {
            const chatDisplay = document.getElementById('chatDisplay');
            const messageDiv = document.createElement('div');
            const messageId = 'chat-msg-' + Date.now();
            messageDiv.id = messageId;
            messageDiv.className = 'chat-message ' + 
                (sender === 'Du' ? 'user-message' : 'assistant-message');
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return messageId;
        }
        
        // H√§mta alla tillg√§ngliga personligheter vid sidladdning
        async function loadPersonalities() {
            try {
                const response = await fetch(`${baseUrl}/personalities`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allPersonalities = await response.json();
                
                // Generera personlightskort
                const grid = document.getElementById('personalityGrid');
                grid.innerHTML = '';
                
                for (const [id, personality] of Object.entries(allPersonalities)) {
                    const card = document.createElement('div');
                    card.className = 'personality-card';
                    if (id === currentPersonality) {
                        card.classList.add('selected');
                    }
                    card.dataset.personality = id;
                    card.innerHTML = `
                        <div class="personality-icon">${personality.icon}</div>
                        <h3>${personality.name}</h3>
                        <p>${personality.description}</p>
                    `;
                    card.addEventListener('click', () => {
                        selectPersonality(id);
                    });
                    grid.appendChild(card);
                }
                
                // Uppdatera UI med aktiv personlighet
                updatePersonalityUI();
            } catch (error) {
                console.error('Fel vid h√§mtning av personligheter:', error);
            }
        }
        
        // V√§lj personlighet
        function selectPersonality(personalityId) {
            // Update the global variable along with the local one
            currentPersonality = personalityId;
            window.currentPersonality = personalityId; // Added line

            // Uppdatera UI
            document.querySelectorAll('.personality-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.personality === personalityId);
            });
            
            updatePersonalityUI();
            
            // St√§ng modal
            document.getElementById('personalityModal').style.display = 'none';
            
            // Visa bekr√§ftelse
            showNotification(`${allPersonalities[personalityId].name} hj√§lper dig nu med dina bryggningar!`);
            
            // Spara val i local storage
            localStorage.setItem('aibrewerPersonality', personalityId);
        }
        
        // Uppdatera UI med aktuell personlighet
        function updatePersonalityUI() {
            const personality = allPersonalities[currentPersonality];
            if (!personality) return;
            
            // Uppdatera sidebar-knapp
            document.getElementById('currentBrewerIcon').textContent = personality.icon;
            document.getElementById('currentBrewerName').textContent = personality.name;
            
            // Uppdatera badge
            document.getElementById('badgeIcon').textContent = personality.icon;
            document.getElementById('badgeName').textContent = personality.name;
        }
        
        // Visa notifikation
        function showNotification(message) {
            // Implementera en enkel notifikation
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '80px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#4CAF50';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Ta bort efter 3 sekunder
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // Event listeners f√∂r UI
        document.getElementById('brewerPersonalityBtn').addEventListener('click', () => {
            document.getElementById('personalityModal').style.display = 'block';
        });
        
        document.getElementById('personalityBadge').addEventListener('click', () => {
            document.getElementById('personalityModal').style.display = 'block';
        });
        
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                document.getElementById('personalityModal').style.display = 'none';
            });
        });
        
        // St√§ng modal om man klickar utanf√∂r
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('personalityModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
    <script src="js/personality-debug.js"></script>
</body>
</html>